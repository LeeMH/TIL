
# 1. 코루틴  취소

* 코루틴이 취소되려면 취소에 `협조`하여야 한다.


# 2. 코루틴이 취소에 협조하는 방법

## 2.1. delay, yield 같은 suspend 함수 사용

- `delay()` / `yield()` 같은 kotlinx.coroutines 패키지의 suspend 함수 사용
- 극단적 예로 cancel 함수를 호출하더라도, 코루틴에서 delay나 yield 같은 suspend 함수를 호출하지 않는다면 결코 취소되지 않는다.

```kotlin
fun main(): Unit = runBlocking{  
    val job = launch {  
        var i = 1  
        var nextPrintTime = System.currentTimeMillis()  
  
        while(i <= 5) {  
            if (nextPrintTime <= System.currentTimeMillis()) {  
                printWithThread("${i++}번째 출력!")  
                nextPrintTime += 1_000L  
            }  
        }  
    }  
  
    delay(100)  
    job.cancel()  
}
```

취소되지 않고, 5번째 출력까지 출력 된다.
![[Pasted image 20241014180102.png]]

![[Pasted image 20241014180149.png]]

## 2.2. isActive 상태를 사용하여 스스로 exception 던지기

- 코루틴 스스로 본인의 상태를 확인해 취소 요청을 받았으면, `CancellationException`을 던지기!
- `isActive`를 이용하여 자신(코루틴)이 active 상태인지 확인할 수 있다.
- 중요한 것은, 만약 코루틴을 별도의 스레드에서 실행하지 않았다면 취소되지 않는다는 것이다.
- 이유는 코루틴이 suspend 함수를 호출하지 않기 때문에, `job.cancel()` 함수가 코루틴 실행중 실행되지 않기 때문이다.
- 아래 에제에서는 해당 문제로 별도의 스레드에서 실행되도록 스레드풀을 설정하였다.


```kotlin
fun main(): Unit = runBlocking{  
    // 별도의 스레드에서 실행시킨다.
    val job = launch(Dispatchers.Default) {  
        var i = 1  
        var nextPrintTime = System.currentTimeMillis()  
  
        while(i <= 5) {  
            if (nextPrintTime <= System.currentTimeMillis()) {  
                printWithThread("${i++}번째 출력!")  
                nextPrintTime += 1_000L  
            }  
  
            if (!isActive) {  
                throw CancellationException()  
            }  
        }  
    }  
  
    delay(100)  
    job.cancel()  
}
```

![[Pasted image 20241014180640.png]]

# 3. delay 역시 CancellationException 사용한다.

- delay 역시 CancellationException을 사용한다.
- try / catch 를 통해 exception을 잡으면, 취소되지 않는다.

```kotlin
fun main(): Unit = runBlocking{  
    val job = launch {  
        try {  
            delay(1_000L)  
        } catch(e: CancellationException) {  
            // 아무것도 안한다.  
        }  
  
        printWithThread("delay에 의해 취소되지 않았다!!!")  
    }  
  
    delay(100)  
    printWithThread("취소 시작")  
    job.cancel()  
}
```

![[Pasted image 20241014190039.png]]